---
title: "在 CentOS 使用 docker \U0001F60B"
tags:
  - centos
categories:
  - docker
cover: 'https://i.loli.net/2021/02/22/N4zMfltBpdeYoZ8.jpg'
excerpt: docker 确实很好用
date: 2020-11-05 00:00:00
link:
---

<h3 id="Docker容器技术的特点"><a href="#Docker容器技术的特点" class="headerlink" title="Docker容器技术的特点"></a>Docker容器技术的特点</h3><figure class="highlight markdown"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">文件系统隔离：每个进程容器运行在完全独立的根文件系统里。</span><br><span class="line">资源隔离：可以使用cgroup为每个进程容器分配不同的系统资源，例如CPU和内存。</span><br><span class="line">网络隔离：每个进程容器运行在自己的网络命名空间里，拥有自己的虚拟接口和IP地址。</span><br><span class="line">写时复制：采用写时复制方式创建根文件系统，这让部署变得极其快捷，并且节省内存和硬盘空间。</span><br><span class="line">日志记录：Docker将会收集和记录每个进程容器的标准流（stdout/stderr/stdin），用于实时检索或批量检索。</span><br><span class="line">变更管理：容器文件系统的变更可以提交到新的映像中，并可重复使用以创建更多的容器。无需使用模板或手动配置。</span><br><span class="line">交互式Shell：Docker可以分配一个虚拟终端并关联到任何容器的标准输入上，例如运行一个一次性交互shell。</span><br><span class="line">所以：ABC对，而D，Docker采用的是资源共享型的管理方案，所有的Docker使用的硬件资源由docker daemon进行管理与分配。</span><br><span class="line"></span><br><span class="line">A.文件、资源、网络隔离</span><br><span class="line">B.变更管理、日志记录</span><br><span class="line">C.写时复制</span><br><span class="line">D.独立的资源划分</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/centos/">centos 安装安装docker官方文档</a></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker <span class="comment"># 删除 老的版本</span></span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="命令（run-start-stop-restart-log）"><a href="#命令（run-start-stop-restart-log）" class="headerlink" title="命令（run/start/stop/restart/log）"></a>命令（run/start/stop/restart/log）</h3><p>win拷贝容器文件到本地（linux 把 copy 换成 cp 即可）</p><figure class="highlight md"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="code">`copy /?`</span>帮助</span><br><span class="line"><span class="bullet">-</span> <span class="code">`docker exec -it jenkins copy test.txt a.html`</span>复制文件到文件</span><br><span class="line"><span class="bullet">-</span> <span class="code">`docker exec -it jenkins copy /var/test.txt a.html`</span>复制文件到文件</span><br><span class="line"><span class="bullet">-</span> <span class="code">`docker exec -it jenkins copy /var/test.txt test\`</span>复制文件或文件夹下的子文件到文件夹</span><br></pre></td></tr></tbody></table></figure><p>重启docker服务</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br><span class="line">sudo service docker restart</span><br></pre></td></tr></tbody></table></figure><p>关闭docker</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop docker</span><br><span class="line">service docker stop</span><br></pre></td></tr></tbody></table></figure><p>doker停止后启动方法</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">systemctl status docker</span><br><span class="line">service docker start</span><br><span class="line">docker run hello-world <span class="comment"># 自带的官网应用</span></span><br></pre></td></tr></tbody></table></figure><p>查看是否启动成功</p><ul><li><code>docker ps -a</code></li></ul><p>查看命令</p><ul><li><code>docker ps</code>正在运行的镜像</li><li><code>docker ps -a</code>所有镜像</li><li><code>netstat -tlunp</code>查看端口</li></ul><p>进入容器内部执行命令</p><ul><li>方法一<code>docker exec -it 38a2cae4c63f sh</code></li><li>方法二<code>docker exec -it blog sh</code></li></ul><p>镜像加速</p><ul><li>方法一<code>docker --registry-mirror=https://registry.docker-cn.com daemon</code></li><li>方法二<code>vi /etc/docker/daemon.json</code>—&gt;<code>{"registry-mirrors":["https://registry.docker-cn.com"]}</code></li><li>重启daemon<code>systemctl daemon-reload</code></li><li>重启docker<code>systemctl restart docker</code></li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker start hello-world <span class="comment"># 也可以是 hello-world 的 id</span></span><br><span class="line">docker rm hello-world <span class="comment"># 也可以是 hello-world 的 id</span></span><br><span class="line">docker stop hello-world <span class="comment"># 也可以是 hello-world 的 id</span></span><br><span class="line">docker restart hello-world <span class="comment"># 也可以是 hello-world 的 id</span></span><br><span class="line">docker <span class="built_in">log</span></span><br><span class="line"><span class="comment"># 在docker反复build后，会存留很多none镜像，下面命令一键删除所有none镜像</span></span><br><span class="line">docker rmi `docker images | grep  <span class="string">'&lt;none&gt;'</span> | awk <span class="string">'{print $3}'</span>`</span><br><span class="line"><span class="comment"># 更简单方法</span></span><br><span class="line">docker rmi `docker images -q -f dangling=<span class="literal">true</span>`</span><br><span class="line">docker rmi $(docker images -q -f dangling=<span class="literal">true</span>)</span><br><span class="line"><span class="comment"># 删除所有停止的容器</span></span><br><span class="line">docker rm $(docker ps -a -q)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者还有</span></span><br><span class="line">docker system prune 按 y</span><br></pre></td></tr></tbody></table></figure><hr><p>安装 <a target="_blank" rel="noopener" href="https://hub.docker.com/_/mysql">mysql</a></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --name test-mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql</span><br><span class="line">docker ps <span class="comment"># test-mysql 已经在运行了</span></span><br><span class="line">docker stop test-mysql</span><br><span class="line">docker start test-mysql</span><br><span class="line">docker logs -f test-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 端口映射出去</span></span><br><span class="line">docker run --name test-mysql -e MYSQL_ROOT_PASSWORD=123456 -p 3306:3306 -d mysql <span class="comment"># 3306 是 docker 内部的端口，映射为外部端口 27000</span></span><br></pre></td></tr></tbody></table></figure><hr><h3 id="容器备份"><a href="#容器备份" class="headerlink" title="容器备份"></a>容器备份</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">docker commit -p 30b8f18f20b4 ali_jenkins</span><br><span class="line">docker login</span><br><span class="line"><span class="comment"># 上传之前，要先对镜像加tag</span></span><br><span class="line"><span class="comment"># tag后面第一个参数是镜像名称，第二个参数是新的tag名称（其中 cxvh 是镜像名称，alijenkins 是）</span></span><br><span class="line">docker tag ali_jenkins cxvh/alijenkins:v1.0</span><br><span class="line">docker push cxvh/alijenkins:v1.0</span><br><span class="line"><span class="comment"># 此时已经备份成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载镜像</span></span><br><span class="line">docker pull cxvh/alijenkins:v1.0</span><br><span class="line"><span class="comment"># 配置 docker-compose.yml 或者直接运行</span></span><br><span class="line">version: <span class="string">"2.2"</span></span><br><span class="line">services:</span><br><span class="line">  jenkins:</span><br><span class="line">    container_name: <span class="string">"jenkins"</span></span><br><span class="line">    <span class="comment"># lts 意思是长期支持版</span></span><br><span class="line">    image: cxvh/alijenkins:v1.0</span><br><span class="line">    restart: always</span><br><span class="line">    user: jenkins:994</span><br><span class="line">    ports:</span><br><span class="line">    - <span class="string">"8001:8080"</span></span><br><span class="line">    - <span class="string">"50000:50000"</span></span><br><span class="line">    - <span class="string">"10051:10051"</span></span><br><span class="line">    volumes:</span><br><span class="line">    - ./data:/var/jenkins_home</span><br><span class="line">    - /usr/bin/docker:/usr/bin/docker</span><br><span class="line">    - /var/run/docker.sock:/var/run/docker.sock</span><br><span class="line"><span class="comment"># 运行起来</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></tbody></table></figure><hr><h3 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h3><ul><li>忘记密码？设置无密码访问docker？<ul><li><code>vi config.xml</code>，改标签<code>useSecurity</code>的值为<code>false</code>，保存退出重启<code>docker</code></li></ul></li><li>如何创建一个在3306端口的容器名称为mysql的Mysql容器，创建后在后台持续运行？<ul><li><code>docker run -itd --name mysql -p 3306:3306 -e=MYSQL_ROOT_PASSWORD=123456 mysql</code><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run 命令来创建</span><br><span class="line">itd交互式终端后台运行</span><br><span class="line">name指定容器名称</span><br><span class="line">p指定映射端口</span><br><span class="line">最后Mysql比较特殊，需要指定MYSQL_ROOT_PASSWORD变量 + mysql镜像名称</span><br><span class="line">正确的命令是：docker run -itd --name mysql -p 3306:3306 -e=MYSQL_ROOT_PASSWORD=123456 mysql</span><br><span class="line">`docker start mysql -p 3306:3306 -e=MYSQL_ROOT_PASSWORD=123456 mysql`与`docker start -p 3306:3306 -e=MYSQL_ROOT_PASSWORD=123456 mysql` start命令只能运行一个已经存在mysql容器，但是无法创建</span><br><span class="line">`docker run -p 3306:3306 -e=MYSQL_ROOT_PASSWORD=123456 mysql`正常创建并运行，但是退出终端后，可能会被停止Mysql</span><br><span class="line"><span class="comment"># 推荐：</span></span><br><span class="line">docker run --name mysql-name -d -p 3306:3306 mysql</span><br><span class="line">然后使用docker start/stop/restart mysql-name命令进行管理</span><br></pre></td></tr></tbody></table></figure></li></ul></li><li>Docker 容器暴露多个端口<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -p &lt;host_port1&gt;:&lt;container_port1&gt; -p &lt;host_port2&gt;:&lt;container_port2&gt;</span><br><span class="line">sudo docker run -it -p 8801:8080 -p 50000:50000 -p 10051:10051 -v /home/jenkins/data:/var/jenkins_home cxvh/alijenkins:v1.0</span><br></pre></td></tr></tbody></table></figure></li><li>Jumpserver<ul><li><code>sudo docker stop $(sudo docker ps -aq)</code>停掉<code>Jumpserver</code>相关的所有容器</li></ul></li><li>在用户权限下<code>docker</code>命令需要<code>sudo</code>，否则报错<code>Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.</code><ul><li>可以把用户添加到用户组</li><li><code>sudo groupadd userdocker</code>添加<code>userdocker</code>用户组</li><li><code>sudo gpasswd -a $USER userdocker</code>将登陆用户加入到<code>userdocker</code>用户组中 or <code>sudo gpasswd -a yonghuming userdocker</code></li><li><code>newgrp docker</code>更新用户组并重启<code>docker</code></li></ul></li></ul><hr><h3 id="常见报错"><a href="#常见报错" class="headerlink" title="常见报错"></a>常见报错</h3><ul><li>重启系统后运行 docker ps 报错？<code>Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</code></li><li>解决方法：<ul><li><code>systemctl daemon-reload</code></li><li><code>systemctl restart docker.service</code></li></ul></li><li>docker 拉取的 mysql 版本不支持？<code>1251 - client does not support authentication protocol requested by server consider upgrading</code></li><li>解决方法：1.指定版本 or 2.升级桌面工具<ul><li>docker pull mysql:5.7.25</li><li>docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7.25</li></ul></li><li>运行<code>gitlab</code><ul><li><code>firewall-cmd --add-port=13800/tcp --permanent</code> 放行端口</li><li><code>firewall-cmd --reload</code> 重新加载</li><li><code>docker logs -f gitlab_test</code> 持续打印日志，看下 gitlab 做了什么事情<ul><li>可以看到默认用户名是 root，第一次访问地址会让创建密码</li></ul></li><li><code>docker rm gitlab_test</code> 删除容器<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --detach \</span><br><span class="line">  --hostname <span class="number">39.100</span><span class="number">.247</span><span class="number">.246</span> \</span><br><span class="line">  --publish <span class="number">443</span>:<span class="number">443</span> --publish <span class="number">13800</span>:<span class="number">80</span> --publish <span class="number">13822</span>:<span class="number">22</span> \</span><br><span class="line">  --name gitlab_test \</span><br><span class="line">  --restart always \</span><br><span class="line">  --volume $GITLAB_HOME/config:/etc/gitlab \</span><br><span class="line">  --volume $GITLAB_HOME/logs:/var/<span class="built_in">log</span>/gitlab \</span><br><span class="line">  --volume $GITLAB_HOME/data:/var/opt/gitlab \</span><br><span class="line">  gitlab/gitlab-ee:latest</span><br></pre></td></tr></tbody></table></figure></li></ul></li></ul>